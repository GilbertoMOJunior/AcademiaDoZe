<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="AcademiaDoZe.Presentation.AppMaui.Views.MatriculaPage"
             xmlns:vm="clr-namespace:AcademiaDoZe.Presentation.AppMaui.ViewModels"
             xmlns:enums="clr-namespace:AcademiaDoZe.Application.Enums;assembly=AcademiDoZe.Application"
             xmlns:converters="clr-namespace:AcademiaDoZe.Presentation.AppMaui.Converters"
             x:DataType="vm:MatriculaViewModel"
             Title="{Binding Title}">

    <ContentPage.Resources>
        <converters:FotoToImageSourceConverter x:Key="FotoToImageSourceConverter" />
        <converters:DateOnlyToDateTimeConverter x:Key="DateOnlyConverter" />
        <converters:EnumDisplayConverter x:Key="EnumDisplay" />
    </ContentPage.Resources>

    <ScrollView>
        <StackLayout Spacing="20">
            <!-- Aluno -->
            <Border Style="{StaticResource CardBorder}" Margin="15,10">
                
                <StackLayout Spacing="10">
                    <Label Text="Aluno" Style="{StaticResource SubHeadline}" />

                    <Grid ColumnDefinitions="*,Auto">
                        
                        <Entry Grid.Column="0" Text="{Binding Matricula.AlunoMatricula.Cpf}" Placeholder="CPF do aluno" Keyboard="Numeric" />
                        <Button Grid.Column="1" Text="" Command="{Binding SearchByCpfCommand}" Style="{StaticResource ButtonPrimary}" HeightRequest="40" Padding="15,0">
                            <Button.ImageSource>
                                <FontImageSource FontFamily="MaterialIcons" Glyph="&#xe8b6;" />
                            </Button.ImageSource>
                        </Button>
                    </Grid>

                    <Border Margin="0,10,0,0" Padding="10" BackgroundColor="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource Gray900}}">
                        <StackLayout>
                            <Image Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2" Grid.RowSpan="11" Source="{Binding Matricula.AlunoMatricula.Foto, Converter={StaticResource FotoToImageSourceConverter}}" Aspect="AspectFill" Margin="0,0,10,0" >

                                <Image.HeightRequest>
                                    <OnIdiom x:TypeArguments="x:Double">
                                        <OnIdiom.Phone>70</OnIdiom.Phone>
                                        <OnIdiom.Tablet>90</OnIdiom.Tablet>
                                        <OnIdiom.Desktop>100</OnIdiom.Desktop>
                                        <OnIdiom.TV>110</OnIdiom.TV>
                                        <OnIdiom.Default>70</OnIdiom.Default>
                                    </OnIdiom>
                                </Image.HeightRequest>
                            </Image>
                            <Label Text="{Binding Matricula.AlunoMatricula.Id, StringFormat='Id: {0}'}" />
                            <Label Text="{Binding Matricula.AlunoMatricula.Nome, StringFormat='Nome: {0}'}" />
                            <Label Text="{Binding Matricula.AlunoMatricula.Email, StringFormat='Email: {0}'}" />
                            <Label Text="{Binding Matricula.AlunoMatricula.Telefone, StringFormat='Telefone: {0}'}" />
                            <Label Text="{Binding Matricula.AlunoMatricula.DataNascimento, StringFormat='Data de nascimento: {0}'}" />
                        </StackLayout>
                    </Border>
                </StackLayout>
            </Border>

            <!-- Plano e Datas -->
            <Border Style="{StaticResource CardBorder}" Margin="15,10">
                <StackLayout Spacing="15">
                    <Label Text="Plano e Período" Style="{StaticResource SubHeadline}" />

                    <!-- Plano -->
                    <StackLayout Spacing="5">
                        <Label Text="Plano" />
                        <Picker ItemsSource="{Binding PlanosMatricula}" 
                    SelectedItem="{Binding PlanoSelecionado}" 
                    ItemDisplayBinding="{Binding ., Converter={StaticResource EnumDisplay}}" />
                    </StackLayout>

                    <!-- Data Início -->
                    <StackLayout Spacing="5">
                        <Label Text="Data de Início" />
                        <DatePicker Date="{Binding DataInicioSelecionada, Converter={StaticResource DateOnlyConverter}, Mode=TwoWay}" 
                        Format="dd/MM/yyyy" />
                    </StackLayout>

                    <!-- Data Fim (Calculada e Somente Leitura) -->
                    <StackLayout Spacing="5">
                        <Label Text="Data de Término" />
                        <DatePicker Date="{Binding DataFimCalculada, Converter={StaticResource DateOnlyConverter}, Mode=OneWay}" 
                        Format="dd/MM/yyyy"
                        IsEnabled="False" />
                    </StackLayout>
                </StackLayout>
            </Border>

            <!-- Objetivo -->
            <Border Style="{StaticResource CardBorder}" Margin="15,10">
                <StackLayout Spacing="10">
                    <Label Text="Objetivo" Style="{StaticResource SubHeadline}" />
                    <Editor Text="{Binding Matricula.Objetivo}" Placeholder="Digite o objetivo do aluno..." AutoSize="TextChanges" />
                </StackLayout>
            </Border>

             <!--Restrições-->
            <Border Style="{StaticResource CardBorder}" Margin="15,10">
                <StackLayout Spacing="15">
                    <Label Text="Restrições" Style="{StaticResource SubHeadline}" />

                    <CollectionView ItemsSource="{Binding RestricoesMatricula}" 
                        SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="0,8" ColumnDefinitions="Auto,*">
                                    <CheckBox Grid.Column="0" 
                                  IsChecked="{Binding IsSelected}"
                                  VerticalOptions="Center" />
                                    <Label Grid.Column="1" 
                               Text="{Binding Nome}" 
                               VerticalOptions="Center"
                               Margin="-85,0,0,0"
                               TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray100}}" />
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <StackLayout Spacing="5">
                        <Label Text="Observações" />
                        <Editor 
                Text="{Binding ObservacoesRestricoes}" 
                Placeholder="Detalhes adicionais..." 
                AutoSize="TextChanges"
                MinimumHeightRequest="100" />
                    </StackLayout>
                </StackLayout>
            </Border>
            <!-- Laudo Médico -->
            <Border Style="{StaticResource CardBorder}" Margin="15,10">
                <StackLayout Spacing="10">
                    <Label Text="Laudo Médico" Style="{StaticResource SubHeadline}" />

                    <Button Text="Selecionar Arquivo" Command="{Binding SelecionarLaudoCommand}" Style="{StaticResource ButtonSecondary}">
                        <Button.ImageSource>
                            <FontImageSource FontFamily="MaterialIcons" Glyph="&#xe226;" />
                        </Button.ImageSource>
                    </Button>
                </StackLayout>
            </Border>

            <!-- Botões -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="10" Margin="15,10">
                <Button Grid.Column="0" Text="Cancelar" Command="{Binding CancelCommand}" Style="{StaticResource ButtonSecondary}" HeightRequest="50">
                    <Button.ImageSource>
                        <FontImageSource FontFamily="MaterialIcons" Glyph="&#xe5c9;" />
                    </Button.ImageSource>
                </Button>

                <Button Grid.Column="1" Text="Salvar" Command="{Binding SaveMatriculaCommand}" Style="{StaticResource ButtonPrimary}" HeightRequest="50">
                    <Button.ImageSource>
                        <FontImageSource FontFamily="MaterialIcons" Glyph="&#xe161;" />
                    </Button.ImageSource>
                </Button>
            </Grid>

            <!-- Loading -->
            <ActivityIndicator IsVisible="{Binding IsBusy}" IsRunning="{Binding IsBusy}" VerticalOptions="Center" HorizontalOptions="Center" />
        </StackLayout>
    </ScrollView>
</ContentPage>
